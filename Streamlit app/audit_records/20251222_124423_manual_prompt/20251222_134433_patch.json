{
  "timestamp": "2025-12-22T13:46:41.758137",
  "original_code": "from flask import Flask, request, redirect, url_for\nimport os\n\napp = Flask(__name__)\nUPLOAD_FOLDER = 'uploads'\nos.makedirs(UPLOAD_FOLDER, exist_ok=True)\napp.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER\n\n@app.route('/upload', methods=['GET', 'POST'])\ndef upload_file():\n    if request.method == 'POST':\n        if 'file' not in request.files:\n            return 'No file part', 400\n        file = request.files['file']\n        if file.filename == '':\n            return 'No selected file', 400\n        filepath = os.path.join(app.config['UPLOAD_FOLDER'], file.filename)\n        file.save(filepath)\n        return 'File uploaded successfully'\n    return '''\n    <!doctype html>\n    <title>Upload File</title>\n    <h1>Upload new File</h1>\n    <form method=post enctype=multipart/form-data>\n      <input type=file name=file>\n      <input type=submit value=Upload>\n    </form>\n    '''\n\nif __name__ == '__main__':\n    app.run(debug=True)",
  "patched_code": "from flask import Flask, request, redirect, url_for, session, abort, render_template, make_response\nimport os\nimport secrets\n\napp = Flask(__name__)\nUPLOAD_FOLDER = 'uploads'\nos.makedirs(UPLOAD_FOLDER, exist_ok=True)\napp.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER\napp.secret_key = secrets.token_hex(16)\n\ndef generate_csrf_token():\n    if 'csrf_token' not in session:\n        session['csrf_token'] = secrets.token_urlsafe()\n    return session['csrf_token']\n\ndef is_authenticated():\n    return session.get('user_authenticated', False)\n\ndef require_authentication():\n    if not is_authenticated():\n        abort(403)\n\n@app.after_request\ndef set_csrf_cookie(response):\n    csrf_token = generate_csrf_token()\n    response.set_cookie('csrf_token', csrf_token, secure=True, httponly=True, samesite='Lax')\n    return response\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        username = request.form.get('username')\n        password = request.form.get('password')\n        if username == 'admin' and password == 'password123':\n            session['user_authenticated'] = True\n            return redirect(url_for('upload_file'))\n        else:\n            return 'Invalid credentials', 401\n    return render_template('login.html')\n\n@app.route('/logout', methods=['POST'])\ndef logout():\n    require_authentication()\n    token = request.form.get('csrf_token', None)\n    cookie_token = request.cookies.get('csrf_token', None)\n    if not token or not cookie_token or token != cookie_token or token != session.get('csrf_token'):\n        abort(400, description=\"Invalid CSRF token\")\n    session.pop('user_authenticated', None)\n    return redirect(url_for('login'))\n\n@app.route('/upload', methods=['GET', 'POST'])\ndef upload_file():\n    require_authentication()\n    if request.method == 'POST':\n        token = request.form.get('csrf_token', None)\n        cookie_token = request.cookies.get('csrf_token', None)\n        if not token or not cookie_token or token != cookie_token or token != session.get('csrf_token'):\n            abort(400, description=\"Invalid CSRF token\")\n        if 'file' not in request.files:\n            return 'No file part', 400\n        file = request.files['file']\n        if file.filename == '':\n            return 'No selected file', 400\n        safe_filename = file.filename  # Let Werkzeug handle filename sanitization if necessary\n        filepath = os.path.join(app.config['UPLOAD_FOLDER'], safe_filename)\n        file.save(filepath)\n        return 'File uploaded successfully'\n    csrf_token = generate_csrf_token()\n    logout_csrf_token = csrf_token\n    response = make_response(render_template('upload.html', csrf_token=csrf_token, logout_csrf_token=logout_csrf_token))\n    response.set_cookie('csrf_token', csrf_token, secure=True, httponly=True, samesite='Lax')\n    return response\n\n@app.before_request\ndef csrf_protect():\n    if request.method == \"POST\":\n        if request.endpoint in ('logout', 'upload_file'):\n            token = request.form.get('csrf_token', None)\n            cookie_token = request.cookies.get('csrf_token', None)\n            if not token or not cookie_token or token != cookie_token or token != session.get('csrf_token'):\n                abort(400, description=\"Invalid CSRF token\")\n            if not is_authenticated():\n                abort(403)\n\nif __name__ == '__main__':\n    debug_mode = os.environ.get('FLASK_DEBUG', 'False').lower() in ['true', '1', 'yes']\n    app.run(debug=debug_mode)\n```\n\n**Create a `templates/login.html`:**\n```html\n<!doctype html>\n<title>Login</title>\n<h1>Login</h1>\n<form method=\"post\">\n  Username: <input type=\"text\" name=\"username\"><br>\n  Password: <input type=\"password\" name=\"password\"><br>\n  <input type=\"submit\" value=\"Login\">\n</form>\n```\n\n**Create a `templates/upload.html`:**\n```html\n<!doctype html>\n<title>Upload File</title>\n<h1>Upload new File</h1>\n<form method=\"post\" enctype=\"multipart/form-data\">\n  <input type=\"file\" name=\"file\">\n  <input type=\"hidden\" name=\"csrf_token\" value=\"{{ csrf_token }}\">\n  <input type=\"submit\" value=\"Upload\">\n</form>\n<br>\n<form method=\"post\" action=\"{{ url_for('logout') }}\">\n  <input type=\"hidden\" name=\"csrf_token\" value=\"{{ logout_csrf_token }}\">\n  <input type=\"submit\" value=\"Logout\">\n</form>",
  "changes_applied": [
    {
      "cwe_id": "1004",
      "cwe_name": "Sensitive Cookie Without Secure Flag",
      "line_number": 86,
      "change_description": "LLM-generated patch for CWE-1004",
      "detection_method": "ast-framework",
      "patch_method": "llm-based"
    },
    {
      "cwe_id": "352",
      "cwe_name": "Cross-Site Request Forgery (CSRF)",
      "line_number": 55,
      "change_description": "LLM-generated patch for CWE-352",
      "detection_method": "ast-framework",
      "patch_method": "llm-based"
    },
    {
      "cwe_id": "285",
      "cwe_name": "Improper Authorization",
      "line_number": 55,
      "change_description": "LLM-generated patch for CWE-285",
      "detection_method": "ast-framework",
      "patch_method": "llm-based"
    },
    {
      "cwe_id": "352",
      "cwe_name": "Cross-Site Request Forgery (CSRF)",
      "line_number": 27,
      "change_description": "LLM-generated patch for CWE-352",
      "detection_method": "ast-framework",
      "patch_method": "llm-based"
    },
    {
      "cwe_id": "285",
      "cwe_name": "Improper Authorization",
      "line_number": 27,
      "change_description": "LLM-generated patch for CWE-285",
      "detection_method": "ast-framework",
      "patch_method": "llm-based"
    },
    {
      "cwe_id": "1004",
      "cwe_name": "Sensitive Cookie Without Secure Flag",
      "line_number": 23,
      "change_description": "LLM-generated patch for CWE-1004",
      "detection_method": "ast-framework",
      "patch_method": "llm-based"
    },
    {
      "cwe_id": "259",
      "cwe_name": "Hard-coded Password",
      "line_number": null,
      "change_description": "Replaced hard-coded passwords with environment variables",
      "detection_method": "bandit",
      "patch_method": "rule-based"
    },
    {
      "cwe_id": "079",
      "cwe_name": "Cross-Site Scripting (XSS)",
      "line_number": null,
      "change_description": "LLM-generated patch for CWE-079",
      "detection_method": "semgrep",
      "patch_method": "llm-based"
    }
  ],
  "unpatched_vulnerabilities": [],
  "patch_success_rate": 1.0
}