--- original.py+++ patched.py@@ -1,9 +1,15 @@-from Crypto.Cipher import AES
-from Crypto.Util.Padding import pad
-import base64
+from Cryptodome.Cipher import AES
+from Cryptodome.Util.Padding import pad
+from Cryptodome.Random import get_random_bytes
+from Cryptodome.Protocol.KDF import PBKDF2
+from Cryptodome.Hash import SHA256
+from Cryptodome.Protocol.KDF import HKDF
 
-def aes_cbc_encrypt(key: bytes, data: bytes) -> bytes:
-    iv = b'\x00' * 16
-    cipher = AES.new(key, AES.MODE_CBC, iv)
-    ct = cipher.encrypt(pad(data, AES.block_size))
-    return ct+def aes_gcm_encrypt(password: str, data: bytes) -> bytes:
+    salt = get_random_bytes(16)
+    # Derive a strong key using HKDF based on PBKDF2 output
+    pbkdf2_key = PBKDF2(password, salt, dkLen=32, count=200000, hmac_hash_module=SHA256)
+    key = HKDF(master=pbkdf2_key, key_len=32, salt=salt, hashmod=SHA256)
+    cipher = AES.new(key, AES.MODE_GCM)
+    ciphertext, tag = cipher.encrypt_and_digest(data)
+    return salt + cipher.nonce + tag + ciphertext